<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Background Changer</title>
<link rel="manifest" href="manifest.json">
<style>
body {
    margin: 0;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    transition: background 1s ease-in-out;
    font-family: Arial, sans-serif;
    color: white;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}
.control-box {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.6);
    padding: 20px;
    border-radius: 12px;
    backdrop-filter: blur(8px);
    width: 360px;
}
.control-box label {
    display: block;
    margin-top: 10px;
    font-size: 0.9em;
}
.control-box select,
.control-box input[type="color"],
.control-box input[type="text"],
.control-box button {
    width: 100%;
    padding: 8px;
    margin-top: 6px;
    border: none;
    border-radius: 6px;
    outline: none;
    font-size: 1em;
}
.control-box button {
    cursor: pointer;
    margin-top: 12px;
}
</style>
</head>
<body>

<div class="control-box">
    <label>Background Source:</label>
    <select id="sourceSelect" onchange="onSourceChange()">
        <option value="unsplash">Online (Unsplash)</option>
        <option value="local">Upload Local Images</option>
        <option value="solid">Solid Color</option>
        <option value="gradient">Gradient Color</option>
        <option value="link">Custom Image via URL</option>
    </select>

    <div id="extraOptions"></div>

    <label>Change Interval:</label>
    <select id="timeSelect">
        <option value="refresh">On Refresh</option>
        <option value="5m">Every 5 Minutes</option>
        <option value="10m">Every 10 Minutes</option>
        <option value="15m">Every 15 Minutes</option>
        <option value="30m">Every 30 Minutes</option>
        <option value="1h">Every 1 Hour</option>
        <option value="2h">Every 2 Hours</option>
        <option value="daily">Daily</option>
    </select>

    <label>Shuffle Mode:</label>
    <select id="shuffleSelect">
        <option value="on">ON</option>
        <option value="off">OFF</option>
    </select>

    <button onclick="applySettings()">Apply Settings</button>
    <button onclick="nextBackground()">Next Background</button>
</div>

<script>
// --- Global State ---
let localImages = JSON.parse(localStorage.getItem('localImages') || '[]');
let currentIndex = Number(localStorage.getItem('currentIndex') || 0);

// --- Gradient Styles ---
const gradientStyles = {
    'linear-to-right': 'to right',
    'linear-to-left': 'to left',
    'linear-to-top': 'to top',
    'linear-to-bottom': 'to bottom',
    'linear-to-tr': 'to top right',
    'linear-to-bl': 'to bottom left',
    'radial-circle': 'circle',
    'radial-ellipse': 'ellipse',
    'conic': 'conic'
};

// --- UI Handlers ---
function onSourceChange(){
    const src = document.getElementById('sourceSelect').value;
    const extra = document.getElementById('extraOptions');
    extra.innerHTML = '';

    if(src==='link'){
        extra.innerHTML=`<input type="text" id="linkInput" placeholder="Enter image URL" value="${localStorage.getItem('linkInput')||''}">`;
    } else if(src==='solid'){
        extra.innerHTML=`
            <input type="color" id="colorPicker" value="${localStorage.getItem('colorPicker')||'#ffffff'}">
            <label><input type="checkbox" id="randomSolid" ${localStorage.getItem('randomSolid')==='true'?'checked':''}> Use Random Solid Color</label>
        `;
    } else if(src==='gradient'){
        extra.innerHTML=`
            <label>Gradient Style:</label>
            <select id="gradientStyle">
                <option value="linear-to-right">Linear: to right</option>
                <option value="linear-to-left">Linear: to left</option>
                <option value="linear-to-top">Linear: to top</option>
                <option value="linear-to-bottom">Linear: to bottom</option>
                <option value="linear-to-tr">Linear: to top right</option>
                <option value="linear-to-bl">Linear: to bottom left</option>
                <option value="radial-circle">Radial: circle</option>
                <option value="radial-ellipse">Radial: ellipse</option>
                <option value="conic">Conic</option>
            </select>
            <label>From Color:</label><input type="color" id="gradFrom" value="${localStorage.getItem('gradFrom')||'#ff7e5f'}">
            <label>To Color:</label><input type="color" id="gradTo" value="${localStorage.getItem('gradTo')||'#feb47b'}">
            <label><input type="checkbox" id="randomGradient" ${localStorage.getItem('randomGradient')==='true'?'checked':''}> Use Random Gradient Colors</label>
        `;
        document.getElementById('gradientStyle').value = localStorage.getItem('gradientStyle')||'linear-to-right';
    } else if(src==='local'){
        extra.innerHTML='<input type="file" id="fileInput" accept="image/*" multiple>';
        document.getElementById('fileInput')?.addEventListener('change', handleLocalFiles);
    }
}

function handleLocalFiles(e){
    const files = Array.from(e.target.files);
    const urls = files.map(f=>URL.createObjectURL(f));
    localImages = localImages.concat(urls);
    if(localImages.length>50) localImages=localImages.slice(-50);
    localStorage.setItem('localImages', JSON.stringify(localImages));
}

// --- Helper Functions ---
function getUnsplashRandomUrl(){ return 'https://source.unsplash.com/random/1920x1080?t=' + Date.now(); }
function getIntervalMs(mode){
    switch(mode){
        case '5m': return 5*60*1000;
        case '10m': return 10*60*1000;
        case '15m': return 15*60*1000;
        case '30m': return 30*60*1000;
        case '1h': return 60*60*1000;
        case '2h': return 2*60*60*1000;
        case 'daily': return 24*60*60*1000;
        default: return 0;
    }
}
function getNextIndex(len, shuffle){ return shuffle==='on'? Math.floor(Math.random()*len) : (currentIndex+1)%len; }

// Random Color Utilities
function getRandomColor(){
    const letters='0123456789ABCDEF';
    let color='#';
    for(let i=0;i<6;i++) color+=letters[Math.floor(Math.random()*16)];
    return color;
}
function getRandomGradientCSS(){
    const style=document.getElementById('gradientStyle')?.value||'linear-to-right';
    const from=getRandomColor();
    const to=getRandomColor();
    if(style.startsWith('linear')) return `linear-gradient(${gradientStyles[style]}, ${from}, ${to})`;
    if(style.startsWith('radial')) return `radial-gradient(${gradientStyles[style]}, ${from}, ${to})`;
    if(style==='conic') return `conic-gradient(from 0deg at center, ${from}, ${to})`;
    return `linear-gradient(to right, ${from}, ${to})`;
}
function getGradientCSS(){
    const style=document.getElementById('gradientStyle')?.value||'linear-to-right';
    const from=document.getElementById('gradFrom')?.value||'#ff7e5f';
    const to=document.getElementById('gradTo')?.value||'#feb47b';
    if(style.startsWith('linear')) return `linear-gradient(${gradientStyles[style]}, ${from}, ${to})`;
    if(style.startsWith('radial')) return `radial-gradient(${gradientStyles[style]}, ${from}, ${to})`;
    if(style==='conic') return `conic-gradient(from 0deg at center, ${from}, ${to})`;
    return `linear-gradient(to right, ${from}, ${to})`;
}

// --- Main Background Function ---
function setBackground(type,index=0){
    let bg='';
    if(type==='unsplash'){ bg=`url('${getUnsplashRandomUrl()}')`; }
    else if(type==='local'){
        if(localImages.length===0) return;
        if(localImages.length===1){
            index = 0; // always single image
        } else {
            index = index || getNextIndex(localImages.length, localStorage.getItem('shuffleMode')||'on');
        }
        bg=`url('${localImages[index]}')`;
    }
    else if(type==='solid'){
        const useRandom=document.getElementById('randomSolid')?.checked;
        bg = useRandom ? getRandomColor() : (document.getElementById('colorPicker')?.value || '#ffffff');
    }
    else if(type==='gradient'){
        const useRandom=document.getElementById('randomGradient')?.checked;
        bg = useRandom ? getRandomGradientCSS() : getGradientCSS();
    }
    else if(type==='link'){ const url=document.getElementById('linkInput')?.value; if(!url)return; bg=`url('${url}')`; }

    document.body.style.background=bg;
    currentIndex=index;

    // Save all applied settings
    localStorage.setItem('bgType', type);
    localStorage.setItem('currentIndex', index);
    localStorage.setItem('lastChange', Date.now());
    localStorage.setItem('colorPicker', document.getElementById('colorPicker')?.value||'#ffffff');
    localStorage.setItem('gradFrom', document.getElementById('gradFrom')?.value||'#ff7e5f');
    localStorage.setItem('gradTo', document.getElementById('gradTo')?.value||'#feb47b');
    localStorage.setItem('gradientStyle', document.getElementById('gradientStyle')?.value||'linear-to-right');
    localStorage.setItem('randomSolid', document.getElementById('randomSolid')?.checked||false);
    localStorage.setItem('randomGradient', document.getElementById('randomGradient')?.checked||false);
    localStorage.setItem('linkInput', document.getElementById('linkInput')?.value||'');
}

// --- Next Background ---
function nextBackground(){
    const type=localStorage.getItem('bgType')||'unsplash';
    const shuffle=localStorage.getItem('shuffleMode')||'on';
    let nextIndex = 0;
    if(type==='local' && localImages.length>1){
        nextIndex = getNextIndex(localImages.length, shuffle);
    }
    setBackground(type, nextIndex);
}

// --- Apply Settings ---
function applySettings(){
    const type=document.getElementById('sourceSelect').value;
    const shuffle=document.getElementById('shuffleSelect').value;
    const mode=document.getElementById('timeSelect').value;
    localStorage.setItem('bgMode', mode);
    localStorage.setItem('shuffleMode', shuffle);
    localStorage.setItem('bgType', type);
    nextBackground();
    setupInterval();
}

// --- Interval ---
let intervalId=null;
function setupInterval(){
    if(intervalId) clearInterval(intervalId);
    const mode=localStorage.getItem('bgMode')||'refresh';
    const interval=getIntervalMs(mode);
    if(interval>0) intervalId=setInterval(nextBackground, interval);
}

// --- Load initial background and restore settings ---
function loadInitialBackground(){
    // Restore settings
    document.getElementById('sourceSelect').value = localStorage.getItem('bgType')||'unsplash';
    document.getElementById('timeSelect').value = localStorage.getItem('bgMode')||'refresh';
    document.getElementById('shuffleSelect').value = localStorage.getItem('shuffleMode')||'on';

    onSourceChange(); // rebuild extraOptions with stored values

    const type=localStorage.getItem('bgType')||'unsplash';
    const lastChange=Number(localStorage.getItem('lastChange')||0);
    const mode=localStorage.getItem('bgMode')||'refresh';
    const interval=getIntervalMs(mode);
    const index=Number(localStorage.getItem('currentIndex')||0);

    if(mode==='refresh'||Date.now()-lastChange>=interval) nextBackground();
    else setBackground(type,index);

    setupInterval();
}

// --- Keyboard Shortcuts ---
document.addEventListener('keydown', e=>{
    if(e.key==='ArrowRight') nextBackground();
    if(e.key==='ArrowLeft'){
        const type=localStorage.getItem('bgType')||'unsplash';
        if(type==='local' && localImages.length>1){
            const len=localImages.length; 
            const shuffle=localStorage.getItem('shuffleMode')||'on'; 
            let prevIndex=shuffle==='on'? Math.floor(Math.random()*len) : (currentIndex-1+len)%len; 
            setBackground(type, prevIndex); 
        }
        else nextBackground();
    }
    if(e.key.toLowerCase()==='s'){ 
        const shuffle=localStorage.getItem('shuffleMode')||'on'; 
        localStorage.setItem('shuffleMode', shuffle==='on'?'off':'on'); 
        alert('Shuffle: '+(shuffle==='on'?'OFF':'ON')); 
    }
});

// --- PWA Service Worker ---
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').then(()=>console.log('SW registered')); }

// --- Initialize ---
loadInitialBackground();
</script>
</body>
</html>